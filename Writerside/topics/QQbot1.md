---
title: QQbot
id: f2982b11-0c7d-4501-af58-c44f598ca6b7
date: 2025-03-31 00:13:07
auther: tachyon
cover: 
excerpt: QQBot é¦–å…ˆå®‰è£…æœºå™¨äººæ¡†æ¶Napcatï¼Œç„¶åæŒ‰ç…§æ–‡æ¡£è¿›è¡Œé…ç½®ï¼Œå³å¯è¿è¡ŒQQæœºå™¨äººã€‚æˆ‘ä»¬è¦é€šè¿‡ è¿™ä¸ªä¸œè¥¿æ¥å®ç°qqæ¶ˆæ¯å’Œnonebotçš„æ¶ˆæ¯äº’é€šã€‚ğŸ’•ğŸ’•ğŸ’• åŸç†ï¼š napcatä¼šç›‘å¬qqæ¶ˆæ¯ï¼Œç„¶åå°†æ¶ˆæ¯è½¬å‘ç»™nonebot nonebotæ ¹æ®æ”¶åˆ°çš„æ¶ˆæ¯è§¦å‘åŠŸèƒ½æ’ä»¶ï¼Œ æ’ä»¶å°†ç”Ÿæˆçš„å†…å®¹å‘é€åˆ°qq
permalink: /archives/wei-ming-ming-wen-zhang
categories:
tags: 
---

## QQBot
<font color=DeepPink>é¦–å…ˆå®‰è£…æœºå™¨äººæ¡†æ¶Napcatï¼Œç„¶åæŒ‰ç…§æ–‡æ¡£è¿›è¡Œé…ç½®ï¼Œå³å¯è¿è¡ŒQQæœºå™¨äººã€‚æˆ‘ä»¬è¦é€šè¿‡
è¿™ä¸ªä¸œè¥¿æ¥å®ç°qqæ¶ˆæ¯å’Œnonebotçš„æ¶ˆæ¯äº’é€šã€‚</font>ğŸ’•ğŸ’•ğŸ’•


<mark>åŸç†ï¼š</mark>
<font color=DarkViolet>
1. napcatä¼šç›‘å¬qqæ¶ˆæ¯ï¼Œç„¶åå°†æ¶ˆæ¯è½¬å‘ç»™nonebot
2. nonebotæ ¹æ®æ”¶åˆ°çš„æ¶ˆæ¯è§¦å‘åŠŸèƒ½æ’ä»¶ï¼Œ
3. æ’ä»¶å°†ç”Ÿæˆçš„å†…å®¹å‘é€åˆ°qqä¸­ã€‚</font>

åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç ã€‚
### ç¬¬ä¸€æ­¥ï¼šå®‰è£…Napcat!
è‡ªå·±å»å®˜ç½‘æ ¹æ®è‡ªå·±çš„ç³»ç»Ÿä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼Œç„¶åå®‰è£…å³å¯ã€‚
æˆ‘ç”¨çš„æ˜¯windowsæ— å¤´ç‰ˆã€‚å®˜ç½‘æŒ‡è·¯[Napcat](https://napneko.github.io/guide/napcat)ã€‚

### ç¬¬äºŒæ­¥ï¼šé…ç½®Napcat
<mark>ç¬”è€…è¿™é‡Œæ²¡æœ‰å›¾åºŠï¼ˆä¸æƒ³èŠ±é‚£ç‚¹ç±³ï¼‰ï¼Œå°±ä¸ä¸Šå›¾ç‰‡æŒ‡å¼•äº†ï¼Œ</mark>å®‰è£…å¥½ååœ¨æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°`napcat.bat`æ–‡ä»¶,åŒå‡»ç›´æ¥è¿è¡Œã€‚è¿™æ—¶å€™å°±ä¼šè®©ä½ ç™»å½•ï¼Œåœ¨è·³å‡ºæ¥çš„ç»ˆç«¯
ä¸­ä½ å¯ä»¥çœ‹åˆ°weibuçš„åœ°å€ï¼Œç±»ä¼¼äº`http://127.0.0.1:xxxxx`ã€‚`ctrl+é¼ æ ‡å·¦é”®`ç‚¹å‡»è¿™ä¸ªåœ°å€ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œç„¶åæ ¹æ®æŒ‡å¼•ç™»å½•QQå³å¯è¿›å…¥æ§åˆ¶é¢æ¿ã€‚

ç„¶åï¼Œç½‘ç»œé…ç½®çš„ä½ç½®åˆ›å»ºçš„ä¸€ä¸ªåå‘ä»£ç†websocketæœåŠ¡å™¨ï¼Œä¸‹é¢æ˜¯æ³¨æ„äº‹é¡¹ï¼š
<font color=HotPink>
* åç§°çˆ±å’‹å¡«å’‹å¡«.
* url:`ws://ï¼ˆä½ çš„qqbotè¿è¡Œçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯åé¢æåˆ°çš„bot.pyè¿è¡Œçš„ç«¯å£ï¼‰/onebot/v11/ws`
* Token:éšä¾¿å¡«ï¼Œä½†æ˜¯è¦å’Œbot.pyä¸­çš„é…ç½®ä¸€è‡´(è¯¦æƒ…è§bot.pyéƒ¨åˆ†çš„ä»‹ç»)
å…¶ä»–ä¿æŒé»˜è®¤å³å¯ï¼Œæ ¹æ®å¯»æ±‚è€…çš„éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</font>
### ç¬¬ä¸‰æ­¥ï¼šæœºå™¨äººç¨‹åº
ç›´æ¥ä¸Šä»£ç ï¼š

#### ä¸»ç¨‹åºbot.pyï¼š
```python
from nonebot import init, get_driver, load_plugin
from nonebot.adapters.onebot.v11 import Adapter as OneBotV11Adapter
import sys
import os
# å°† PaddleSpeech çš„è·¯å¾„æ·»åŠ åˆ° sys.path
paddlespeech_path = os.path.join(os.path.dirname(__file__), "PaddleSpeech")
sys.path.append(paddlespeech_path)
# åˆå§‹åŒ– NoneBot
init()

# è·å–å…¨å±€é©±åŠ¨
driver = get_driver()
# åŠ è½½å•ä¸ªæ’ä»¶
load_plugin("plugin.demulan")
#load_plugin("plugin.chat_demulan")
#load_plugin("plugin.tts")  # åŠ è½½è¯­éŸ³åˆæˆæ’ä»¶
load_plugin("plugin.tts2")  # åŠ è½½æ–°çš„è¯­éŸ³åˆæˆæ’ä»¶
load_plugin("plugin.chat_tts")  # åŠ è½½æ–°çš„è¯­éŸ³åˆæˆæ’ä»¶


# æ³¨å†Œé€‚é…å™¨
driver.register_adapter(OneBotV11Adapter)

if __name__ == "__main__":
    # å¯åŠ¨ NoneBot
    driver.run()
<font color=HotPink>
```
ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š
1. é¦–å…ˆå¯¼å…¥äº†ä¸€äº›å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬syså’Œosï¼Œç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„å’Œç³»ç»Ÿç›¸å…³æ“ä½œã€‚
2. ç„¶åï¼Œå°† PaddleSpeech çš„è·¯å¾„æ·»åŠ åˆ° sys.path ä¸­ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶èƒ½å¤Ÿæ­£ç¡®å¯¼å…¥ PaddleSpeech æ¨¡å—ã€‚ï¼ˆttsæ’ä»¶éœ€è¦ç”¨åˆ°ï¼‰
3. æ¥ç€ï¼Œåˆå§‹åŒ–äº† NoneBotï¼Œå¹¶è·å–![tlsy.png](/upload/tlsy.png)
äº†å…¨å±€é©±åŠ¨å¯¹è±¡ã€‚
4. ç„¶åï¼ŒåŠ è½½äº†å‡ ä¸ªæ’ä»¶ï¼ˆåŠŸèƒ½ä»‹ç»è§æ’ä»¶éƒ¨åˆ†ï¼‰
5. æœ€åï¼Œæ³¨å†Œäº† OneBotV11Adapter é€‚é…å™¨ï¼Œå¹¶å¯åŠ¨äº† NoneBotã€‚
</font>

#### æ’ä»¶éƒ¨åˆ†ï¼š
1. demulan.pyï¼š
```python
from nonebot import on_message
from nonebot.adapters.onebot.v11 import MessageSegment
from nonebot.rule import keyword
import os
import base64

# å®šä¹‰å…³é”®è¯å’Œå¯¹åº”çš„è¯­éŸ³æ–‡ä»¶
keywords = {
    "è¿Ÿç–‘": "å¤¹æªå·¡é€»ä¸è¦è®©æˆ‘å¬åˆ°è¿Ÿç–‘çš„å£°éŸ³.mp3",
    "çŒ›æ”»": "å¤¹æªå·¡é€»ä¸è¦è®©æˆ‘å¬åˆ°è¿Ÿç–‘çš„å£°éŸ³.mp3",
}

# åˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨
demulan = on_message(rule=keyword(*keywords.keys()))

@demulan.handle()
async def handle_demulan(bot, event):
    for word, voice_file in keywords.items():
        if word in event.get_plaintext():
            voice_path = os.path.join("voices", voice_file)
            if os.path.exists(voice_path):
                # è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸º Base64
                with open(voice_path, "rb") as f:
                    voice_data = base64.b64encode(f.read()).decode("utf-8")
                # å‘é€ Base64 ç¼–ç çš„è¯­éŸ³æ¶ˆæ¯
                await bot.send(event, MessageSegment.record(file=f"base64://{voice_data}"))
            else:
                await bot.send(event, f"è¯­éŸ³æ–‡ä»¶ {voice_file} æœªæ‰¾åˆ°")
            break
```
<font color=DeepSkyBlue>ä¸€ä¸ªéå¸¸ç®€å•çš„æ’ä»¶ï¼Œç”¨äºæ ¹æ®å…³é”®è¯æ’­æ”¾å¯¹åº”çš„è¯­éŸ³æ–‡ä»¶ã€‚ä»¥QQè¯­éŸ³æ¶ˆæ¯çš„å½¢å¼å‘é€åˆ°ç¾¤èŠä¸­ã€‚è¿™æ˜¯coså¾·ç©†å…°çš„å…¥é—¨çº§æ’ä»¶ã€‚</font>

2. tts2.pyï¼š
```python
from nonebot import on_startswith
from nonebot.adapters.onebot.v11 import MessageSegment, GroupMessageEvent
from nonebot.typing import T_State
import aiohttp
import asyncio
import base64
from pathlib import Path

# åˆ›å»ºå‘½ä»¤å¤„ç†å™¨
tts2 = on_startswith("tts", priority=5, block=True)

# GPT-SOVITS API é…ç½®
GPT_SOVITS_API_URL = "http://127.0.0.1:9880/tts"  # GPT-SOVITS API åœ°å€
REF_AUDIO_PATH = r"E:\QQbot\voices\dml_25.wav"  # å‚è€ƒéŸ³é¢‘è·¯å¾„
PROMPT_TEXT = "çŸ¥é“ä½ åœ¨è°çš„åœ°ç›˜ä¸Šå—ï¼Ÿé—¨å«æ²¡å‘Šè¯‰ä½ å—ï¼Ÿæˆ‘ä»Šå¤©ä¸è§å®¢ã€‚"  # æç¤ºæ–‡æœ¬
PROMPT_LANG = "zh"  # æç¤ºæ–‡æœ¬çš„è¯­è¨€

# éŸ³é¢‘æ–‡ä»¶è¾“å‡ºç›®å½•
WAV_OUTPUT_DIR = r"E:\QQbot\output2"
Path(WAV_OUTPUT_DIR).mkdir(parents=True, exist_ok=True)


async def call_gpt_sovits_api(text: str) -> bytes:
    """
    è°ƒç”¨ GPT-SOVITS API è¿›è¡Œè¯­éŸ³åˆæˆã€‚

    Args:
        text (str): è¦åˆæˆçš„æ–‡æœ¬ã€‚

    Returns:
        bytes: åˆæˆçš„éŸ³é¢‘æ•°æ®ã€‚

    Raises:
        ValueError: å¦‚æœè¯·æ±‚å‚æ•°æ— æ•ˆæˆ– API è¿”å›é”™è¯¯ã€‚
    """
    # æ„é€ è¯·æ±‚å‚æ•°
    payload = {
        "text": text,
        "text_lang": PROMPT_LANG,  # æ–‡æœ¬è¯­è¨€
        "ref_audio_path": REF_AUDIO_PATH,  # å‚è€ƒéŸ³é¢‘è·¯å¾„
        "prompt_text": PROMPT_TEXT,  # æç¤ºæ–‡æœ¬
        "prompt_lang": PROMPT_LANG,  # æç¤ºæ–‡æœ¬è¯­è¨€
        "text_split_method": "cut5",  # æ–‡æœ¬åˆ†å‰²æ–¹æ³•
        "batch_size": 1,  # æ‰¹é‡å¤§å°
        "media_type": "wav",  # è¾“å‡ºéŸ³é¢‘æ ¼å¼
        "streaming_mode": False,  # æ˜¯å¦å¯ç”¨æµå¼å“åº”
    }

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(GPT_SOVITS_API_URL, json=payload) as response:
                if response.status == 200:
                    # è¿”å›éŸ³é¢‘æ•°æ®
                    return await response.read()
                else:
                    # æ•è· API è¿”å›çš„é”™è¯¯ä¿¡æ¯
                    error_info = await response.json()
                    raise ValueError(f"API è¿”å›é”™è¯¯: {error_info.get('message', 'æœªçŸ¥é”™è¯¯')}")
    except Exception as e:
        raise ValueError(f"è¯·æ±‚ GPT-SOVITS API å¤±è´¥: {str(e)}")


@tts2.handle()
async def handle_tts2(event: GroupMessageEvent, state: T_State):
    # æå–ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
    raw_text = event.get_plaintext().strip()
    text = raw_text[len("tts"):].strip()  # å»æ‰å¼€å¤´çš„ "tts"

    if not text:
        await tts2.finish("è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬ã€‚")

    try:
        # è°ƒç”¨ GPT-SOVITS API è¿›è¡Œè¯­éŸ³åˆæˆ
        wav_data = await call_gpt_sovits_api(text)

        # ä¿å­˜éŸ³é¢‘æ–‡ä»¶
        wav_path = Path(WAV_OUTPUT_DIR) / f"{event.user_id}.wav"
        with open(wav_path, "wb") as f:
            f.write(wav_data)

        # è¯»å– WAV æ–‡ä»¶å¹¶è½¬æ¢ä¸º Base64
        with open(wav_path, "rb") as f:
            voice_data = base64.b64encode(f.read()).decode("utf-8")
        voice_message = MessageSegment.record(file=f"base64://{voice_data}")

        # å‘é€è¯­éŸ³æ¶ˆæ¯
        await tts2.send(voice_message)

        # è‰¾ç‰¹ç”¨æˆ·
        await tts2.send(MessageSegment.at(event.user_id) + " è¯­éŸ³åˆæˆå®Œæˆï¼")
    except ValueError as e:
        await tts2.finish(f"è¯­éŸ³åˆæˆå¤±è´¥: {str(e)}")
    except Exception as e:
        await tts2.finish(f"å‘ç”ŸæœªçŸ¥é”™è¯¯: {str(e)}")
```
<font color=HotPink>è¿™æ˜¯ä¸€ä¸ªåŸºäºGPT-SOVITS APIçš„è¯­éŸ³åˆæˆæ’ä»¶ï¼Œç”¨äºå°†ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬è½¬æ¢ä¸ºè¯­éŸ³å¹¶å‘é€ç»™ç”¨æˆ·ã€‚å…³äºè®­ç»ƒçš„éƒ¨åˆ†è§GPT-SOVITSäº‘ç«¯è®­ç»ƒçš„æ–‡ç« ã€‚
å¾·ç©†å…°æœ€çªå‡ºçš„ç‰¹ç‚¹å°±æ˜¯å¥¹çš„æ­£å®—å“ˆå¤«å…‹å£éŸ³ï¼Œæ‰€ä»¥è¯­éŸ³åˆæˆæ˜¯coså¾·ç©†å…°çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¿™é‡Œåªæ˜¯å®ç°è°ƒç”¨apiå’Œå°†æ¶ˆæ¯è½¬æ¢çš„åŠŸèƒ½ï¼Œå…·ä½“åˆæˆï¼Œæ¨ç†çš„éƒ¨åˆ†è¿˜æ˜¯å¾—é 
GPT-SOVITSçš„apiæ¥å®ç°ã€‚ï¼ˆå…³äºapiçš„éƒ¨åˆ†ä¹Ÿè§GPT-SOVITSäº‘ç«¯è®­ç»ƒçš„æ–‡ç« ï¼‰</font>

### å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š

* å¯åŠ¨bot.pyåå°±å¯ä»¥ç›´æ¥çœ‹åˆ°è¿è¡Œçš„ç«¯å£äº†ã€‚
* æƒ³è¦æ·»åŠ æ–°çš„æ’ä»¶åœ¨bot.pyä¸­load_plugin('æ’ä»¶å')å³å¯ã€‚
* è¯­éŸ³åˆæˆæ’ä»¶éœ€è¦é…ç½®GPT-SOVITS APIçš„åœ°å€ï¼Œä»¥åŠåˆæˆå‚æ•°ï¼Œå…·ä½“è§ä»£ç ã€‚

# <font color=DeepPink>ä¸‹ç­ï¼ï¼</font>